<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="icon" href="./assets/img/favicon.ico">
  <title data-i18n="pages.forgot-password.title">Lupa Kata Sandi</title>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:300,400,600,700" rel="stylesheet" />
  <script src="https://kit.fontawesome.com/42d5adcbca.js" crossorigin="anonymous"></script>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100">
  <!-- Navbar -->
  <nav class="absolute top-0 z-10 w-full mt-4">
    <div class="container mx-auto px-4 flex justify-between items-center">
      <a href="./index.html" class="flex items-center text-white space-x-2">
        <img src="assets/img/64.png" width="64" height="64" />
        <p class="text-white font-semibold text-lg">BASIS-64</p>
      </a>
    </div>
  </nav>

  <main class="mt-0">
    <div class="relative min-h-[50vh] pt-20 pb-10 px-4 bg-cover bg-top" style="background-image: url('https://raw.githubusercontent.com/creativetimofficial/public-assets/master/argon-dashboard-pro/assets/img/signup-cover.jpg');">
      <div class="absolute inset-0 bg-black bg-opacity-60"></div>
      <div class="relative z-10 max-w-2xl mx-auto text-center">
        <h1 class="text-white text-3xl font-bold mb-4" data-i18n="pages.forgot-password.contentTitle">Pemulihan Akun</h1>
        <p class="text-white" data-i18n="pages.forgot-password.contentDescription">Jika Anda lupa kata sandi, kami akan mengirimkan OTP ke akun Gmail Anda. Pastikan Anda memeriksa seluruh kotak masuk Anda, termasuk folder spam atau sampah.</p>
      </div>
    </div>

    <div class="relative z-20 max-w-md mx-auto mt-[-6rem] px-4">
      <div class="bg-white rounded-xl shadow p-6">
        <div class="text-center mb-4">
          <h5 class="text-lg font-semibold" data-i18n="pages.forgot-password.resetPassword">Reset Kata Sandi</h5>
        </div>

        <!-- Request OTP -->
        <div id="requestOTP" class="space-y-4">
          <div>
            <input type="email" id="inputEmail" placeholder="example@gmail.com" aria-describedby="invalidEmail" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring" oninput="let status = isGmail(this.value); this.className = status ? 'w-full px-4 py-2 border rounded focus:outline-none focus:ring' : 'w-full px-4 py-2 border rounded border-red-500 focus:outline-none focus:ring'; document.getElementById('requestOTPButton').disabled = !status; document.getElementById('invalidEmail').hidden = status;">
            <p id="invalidEmail" class="text-sm text-red-600" hidden data-i18n="pages.forgot-password.emailError">Alamat email tidak sesuai.</p>
          </div>
          <button type="submit" class="w-full py-2 bg-gray-600 text-white rounded hover:bg-gray-700" id="requestOTPButton" onclick="requestOTPHandler();" disabled data-i18n="pages.forgot-password.getOTP">Dapatkan OTP</button>
        </div>

        <!-- Verify OTP -->
        <div id="verifyOTP" class="space-y-4" hidden>
          <div>
            <input type="text" id="inputOTP" placeholder="Kode OTP" aria-describedby="invalidOTP" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring" oninput="inputOTPHandle();" />
            <p id="invalidOTP" class="text-sm text-red-600" hidden data-i18n="pages.forgot-password.notVerified">OTP tidak dapat diverifikasi.</p>
          </div>
          <button type="submit" class="w-full py-2 bg-gray-200 text-gray-700 rounded" id="requestNewOTPButton" onclick="requestOTPHandler();" disabled></button>
          <button type="submit" class="w-full py-2 bg-gray-600 text-white rounded hover:bg-gray-700" id="verifyOTPButton" onclick="verifyOTPHandler();" data-i18n="pages.forgot-password.verifyOTP">Verifikasi OTP</button>
        </div>

        <!-- Change Password -->
        <div id="changePasswordLayout" class="space-y-4" hidden>
          <div>
            <input type="password" placeholder="Password" id="inputPassword" aria-describedby="invalidPassword" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring" oninput="inputPasswordHandle(this);" required  data-i18n="pages.forgot-password.password"/>
            <p id="invalidPassword" class="text-sm text-red-600" hidden></p>
          </div>
          <div>
            <input type="password" placeholder="Konfirmasi password" id="inputConfirmPassword" aria-describedby="invalidConfirmPassword" class="w-full px-4 py-2 border rounded focus:outline-none focus:ring" oninput="inputConfirmPasswordHandle(this);" required  data-i18n="pages.forgot-password.confirmPassword"/>
            <p id="invalidConfirmPassword" class="text-sm text-red-600" hidden></p>
          </div>
          <button type="submit" class="w-full py-2 bg-gray-600 text-white rounded hover:bg-gray-700" id="changePasswordButton" onclick="changePasswordHandler();" disabled data-i18n="pages.forgot-password.changePassword">Ganti password</button>
        </div>

        <p class="text-sm text-center mt-4" data-i18n="pages.forgot-password.login">Sudah memiliki akun? <a href="login.html" class="text-blue-600 font-semibold">Login</a></p>
      </div>
    </div>
  </main>

  <footer class="py-8 text-center text-sm text-gray-500">
    <div class="space-x-4">
      <a href="about.html" class="hover:underline" data-i18n="pages.forgot-password.about"></a>
      <a href="feedback.html" class="hover:underline" data-i18n="pages.forgot-password.contact">Hubungi kami</a>
      <a href="terms.html" class="hover:underline" data-i18n="pages.forgot-password.terms">Persyaratan layanan</a>
    </div>
    <div class="mt-4 space-x-4">
      <a href="#" class="text-gray-500"><i class="fab fa-dribbble"></i></a>
      <a href="#" class="text-gray-500"><i class="fab fa-twitter"></i></a>
      <a href="#" class="text-gray-500"><i class="fab fa-instagram"></i></a>
      <a href="#" class="text-gray-500"><i class="fab fa-pinterest"></i></a>
      <a href="#" class="text-gray-500"><i class="fab fa-github"></i></a>
    </div>
    <p class="mt-4">Copyright &copy; <script>document.write(new Date().getFullYear())</script> BASIS-64</p>
  </footer>

  <!-- Message modal -->
    <div id="messageModal" tabindex="-1" aria-hidden="true" class="hidden overlay modal overflow-y-auto overflow-x-hidden fixed z-50 justify-center items-center w-full inset-0 h-[calc(100%)] max-h-full bg-black bg-opacity-50"></div>
    <script src="js/jquery.min.js" type="text/javascript"></script>
    <script src="js/simple-datatables.min.js" crossorigin="anonymous"></script>
    <script src="js/i18next.min.js"></script>
    <script src="js/i18nextHttpBackend.min.js"></script>
    <!-- Core theme JS-->
    <script src="js/scripts.js"></script>
    <script src="js/icons.js"></script>
    <script src="js/cookie.js"></script>
    <script src="js/visitor.js"></script>
    <script src="js/encrypt.js"></script>
    <script src="js/initialize.js"></script>
    <script src="js/i18n.js"></script>
  <script type="text/javascript">
          let page_id = "forgot-password";

            let requestOTP = document.getElementById('requestOTP');
            let verifyOTP = document.getElementById('verifyOTP');
            let changePasswordLayout = document.getElementById('changePasswordLayout');

            let inputEmail = document.getElementById('inputEmail');
            let inputPassword = document.getElementById('inputPassword');

            let name;
            let photo;
            let email;
            let password;
            let inputConfirmPassword = document.getElementById('inputConfirmPassword');

            const inputOTP = document.getElementById('inputOTP');
            const requestNewOTPButton = document.getElementById('requestNewOTPButton');
            const requestOTPButton = document.getElementById('requestOTPButton');
            const changePasswordButton = document.getElementById('changePasswordButton');
            const verifyOTPButton = document.getElementById('verifyOTPButton');

            async function requestOTPHandler() {
              let response = await serverRequest('request-otp', {email: inputEmail.value});
              let json = response.data;
              if (!json.ok) {
                messageModal(i18next.t(`pages.forgot-password.${json.error}`));
              }

              requestOTP.hidden = true;
              verifyOTP.hidden = false;
              console.log(response);
              startCountdown((json.expired - new Date().getTime())/1000);

            }

            async function verifyOTPHandler() {
              let response = await serverRequest('verify-otp', {email: inputEmail.value, otp: inputOTP.value});
              console.log(response);
              let json = response.data;
              if (!json.ok) {
                if (json.error == 'TRY_ERROR') {
                  messageModal(i18next.t(`pages.forgot-password.${json.error}`));
                  return;
                } else if (json.error == 'OTP_NOT_SAME') {
                  messageModal(i18next.t(`pages.forgot-password.${json.error}`));
                  return;
                } else {
                  messageModal(i18next.t('pages.forgot-password.UNKNOWN_ERROR'));
                  return;
                }
              }

              verifyOTP.hidden = true;
              changePasswordLayout.hidden = false;
            }

            async function changePasswordHandler() {
              let response = await serverRequest('change-password', {email: inputEmail.value, password: inputPassword.value});
              let json = response.data;
              if (!json.ok) {
                messageModal(i18next.t('pages.forgot-password.UNKNOWN_ERROR'));
                return;
              }

              window.location.replace('index.html');
            }

            function startCountdown(seconds) {
                let counter = seconds;

                function updateCountdown() {
                    requestNewOTPButton.innerHTML = i18next.t('pages.forgot-password.remainingTime').replace('<SECONDS_PLACEHOLDER>', Math.floor(counter));
                    if (counter > 0) {
                        requestNewOTPButton.disabled = true;
                        counter--;
                        setTimeout(updateCountdown, 1000); // Panggil fungsi setiap 1 detik (1000 ms)
                    } else {
                        requestNewOTPButton.innerHTML = i18next.t('pages.forgot-password.requestNewOTP');
                        requestNewOTPButton.disabled = false;
                    }
                }

                updateCountdown();
            }

            function inputPasswordHandle(element) {
              console.log(inputPassword.value.length < 8)
              if (inputPassword.value.length < 8) {
                inputPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-red-500 focus:outline-none focus:ring');
                document.getElementById('invalidPassword').innerHTML = "Password harus lebih dari 8 karakter";
                changePasswordButton.disabled = true;
                return;
              } else if (inputPassword.value != inputConfirmPassword.value) {
                inputPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-red-500 focus:outline-none focus:ring');
                inputConfirmPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-red-500 focus:outline-none focus:ring');
                document.getElementById('invalidPassword').innerHTML = "";
                document.getElementById('invalidConfirmPassword').innerHTML = "Password dan password konfirmasi harus sama";
                changePasswordButton.disabled = true;
                return;
              }

              inputPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-green-500 focus:outline-none focus:ring');
              inputConfirmPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-green-500 focus:outline-none focus:ring');
              changePasswordButton.disabled = false;


            }

            function inputConfirmPasswordHandle(element) {
              console.log(inputPassword.value.length < 8)
              if (inputPassword.value.length < 8) {
                inputPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-red-500 focus:outline-none focus:ring');
                inputConfirmPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-red-500 focus:outline-none focus:ring');
                document.getElementById('invalidConfirmPassword').innerHTML = "Password konfirmasi harus lebih dari 8 karakter";
                changePasswordButton.disabled = true;
                return;
              } else if (inputPassword.value != inputConfirmPassword.value) {
                inputPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-red-500 focus:outline-none focus:ring');
                inputConfirmPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-red-500 focus:outline-none focus:ring');
                document.getElementById('invalidPassword').innerHTML = "";
                document.getElementById('invalidConfirmPassword').innerHTML = "Password dan password konfirmasi harus sama";
                changePasswordButton.disabled = true;
                return;
              }

              inputPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-green-500 focus:outline-none focus:ring');
              inputConfirmPassword.setAttribute('class', 'w-full px-4 py-2 border rounded border-green-500 focus:outline-none focus:ring');
              changePasswordButton.disabled = false;

            }

            function inputOTPHandle() {
              console.log(document.getElementById('inputEmail'));
              const inputValue = inputOTP.value;
              const numberRegex = /^[0-9]+$/;

              if (!numberRegex.test(inputValue)) {
                inputOTP.value = inputValue.replace(/[^0-9]/g, ''); // Hapus karakter non-angka
              }
              if (inputValue.length > 6) {
                inputOTP.value = inputValue.slice(0, 6); // Potong jika lebih dari 6 digit
              }
            }

            function isGmail(email) {
              const emailRegex = /^[^\s@]+@gmail\.com$/;
              return emailRegex.test(email);
            }

            function message(msg) {
                document.getElementById('modalMessage').innerHTML = msg;
                $("#infoModal").modal("show");
            }

            function callback() {
                if (account) {
                    window.location.replace("index.html");
                }
            }
        </script>
</body>

</html>

